<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Simulazioni</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap/css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i&amp;display=swap">
    <link rel="stylesheet" href="{{ url_for('static', filename='fonts/fontawesome-all.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap/css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/css/Login-Form-Basic-icons.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/VentasPro-Login.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.2.4/ol.css">
    <link rel="stylesheet" href="http://unpkg.com/leaflet@1.4.0/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    

    <style>

        .evidenziato {
            background-color: yellow !important;
        }

        .evidenziato_coda {
            background-color: rgb(154, 152, 152) !important;
        }

        .evidenziato_error {
            background-color: red !important;
        }

        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 15px;
            border-radius: 5px;
            background: #d3d3d3;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s; 
            transition: opacity .2s;
        }

        .slider:hover {
            opacity: 1;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none; 
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #04AA6D;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #04AA6D;
            cursor: pointer;
        }

        form {
            display: inline;
        }

        
        .ol-legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: #ffffff;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            font-family: Arial, sans-serif;
            z-index: 1000;
            width: 150px;  
        }

        .ol-legend h4 {
            margin: 0;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .ol-legend div {
            margin-bottom: 5px;
        }

        .ol-legend span {
            width: 20px;
            height: 20px;
            display: inline-block;
            margin-right: 5px;
        }

        .checkbox-container {
            display: inline-block;
            width: 3em;
            height: 3em;
        }

        .custom-checkbox {
            width: 2.5em;
            height: 2.5em;
            border: 2px solid #ccc;
            border-radius: 5px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.3s, border 0.3s;
        }

    </style>
</head>

<!-- onload="controlKmlOnLoad()" -->
<body id="page-top">
    <div id="wrapper">

        <nav class="navbar navbar-dark align-items-start sidebar sidebar-dark accordion bg-gradient-primary p-0">
            <div class="container-fluid d-flex flex-column p-0">
                <a class="navbar-brand d-flex justify-content-center align-items-center sidebar-brand m-0" href="#">
                    <img style="width: 32px;height: 33px;" src="static/img/Regione_Campania-logo-0A3FAC65C4-seeklogo.com.png">
                    <div class="sidebar-brand-icon rotate-n-15"></div>
                    <div class="sidebar-brand-text mx-3"><span>SMOKETRACER</span></div>
                </a>
                <hr class="sidebar-divider my-0">
                <ul class="navbar-nav text-light" id="accordionSidebar">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard"><i class="fas fa-terminal"></i><span style="color: var(--bs-accordion-bg);">Dashboard</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="simulazioni"><i class="fas fa-list"></i><span style="color: var(--bs-accordion-bg);">Simulazioni</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="storico"><i class="fas fa-table"></i><span style="color: var(--bs-accordion-bg);">Storico Simulazioni</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="profilo"><i class="far fa-user-circle"></i><span style="color: var(--bs-accordion-bg);">Profilo Utente</span></a>
                    </li>
                    <li class="nav-item"></li>
                </ul>
                <div class="text-center d-none d-md-inline"><button class="btn rounded-circle border-0" id="sidebarToggle" type="button"></button></div>
            </div>
        </nav>

        <div class="d-flex flex-column" id="content-wrapper">
            <!-- <div id="content"> -->

            <nav class="navbar navbar-light navbar-expand bg-white shadow mb-4 topbar static-top">
                <div class="container-fluid"><button class="btn btn-link d-md-none rounded-circle me-3" id="sidebarToggleTop" type="button"><i class="fas fa-bars"></i></button><small class="form-text fs-4 fw-semibold" style="width: 2348.234px;">Benvenuto! La tua&nbsp;ultima visita risale al: {{ last_access }}&nbsp;</small>
                    <ul class="navbar-nav flex-nowrap ms-auto">
                        <div class="d-none d-sm-block topbar-divider"></div>
                    </ul><small class="form-text" style="margin-left: 0px;width: 450.1641px; font-weight:bold"><h4><b id="name_user_label">{{ user }}</b></h4></small><a href="{{ url_for('logout') }}" class="btn btn-primary" style="white-space: nowrap; text-align: center;">Log Out</a>
                </div>
            </nav>

            <div class="container-fluid">
                <h3 class="text-dark mb-4">Storico Simulazioni</h3>
                <div class="card shadow" style="margin-right: auto;margin-left: 0px;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="text-primary fw-bold m-0">Simulazioni Sottomesse</h6>
                        <form method="POST">
                            <button class="btn btn-danger" type="submit" name="hresetjob" style="margin-left: 2px;font-weight: bold;width: auto;height: auto;color: var(--bs-gray);background: var(--bs-card-cap-bg);border-color: var(--bs-card-cap-bg);"><i class="fas fa-undo"></i></button>
                        </form>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- <form method="POST" id="searchform" class="d-none d-sm-inline-block me-auto ms-md-3 my-2 my-md-0 mw-100 navbar-search"> -->
                                <div class="input-group">
                                    <div class="col-sm-3">
                                        <input class="bg-light form-control border-0 large" type="text" name="hsearchvalue" id="searchnamebar" placeholder="Cerca parola chiave">
                                    </div>
                                    <!-- sotto stava in button anche : type="submit" form="searchform" -->
                                    <button class="btn btn-primary py-0" id="searchnamebutton" name="hsearchbutton" onclick="search()"><i class="fas fa-search"></i></button>

                            <!-- </form> -->
                            <label class="form-label"></label>
                            </div>
                            <!-- <div class="table-responsive table mt-2" id="dataTable" role="grid" aria-describedby="dataTable_info"> -->
                            <div class="table-responsive table mt-2" role="grid" aria-describedby="dataTable_info">
                                <table class="table my-0" id="dataTable">
                                    <thead>
                                        <tr>
                                            <th>Descrizione</th>
                                            <th>Data inizio</th>
                                            <th>Ora inizio</th>
                                            <th>Durata</th>
                                            <th>Comune</th>
                                            <th>Longitudine</th>
                                            <th>Latitudine</th>
                                            <th>Temperatura</th>
                                            <th>Codice GISA</th>
                                            <th>ID</th>
                                            <th>Gruppo</th>
                                            <th>Stato</th>
                                            <th>Scarica</th>
                                            <th>Elimina</th>
                                            
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for job in jobs %}
                                        <tr onclick="evidenziaRiga(this)">
                                            <td>{{ job[0] }}</td>
                                            <td>{{ job[1] }}</td>
                                            <td>{{ job[2] }}</td>
                                            <td>{{ job[3] }}</td>
                                            <td>{{ job[4] }}</td>
                                            <td>{{ job[5] }}</td>
                                            <td>{{ job[6] }}</td>
                                            <td>{{ job[7] }}</td>
                                            <td>{{ job[8] }}</td>
                                            <td>{{ job[9] }}</td>
                                            <td>{{ job[12] }}</td>

                                            <!-- <td><input type="checkbox" class="form-check-input" style="width: 2.5em; height: 2.5em;" disabled></td> -->
                                            <td><div id="custom-checkbox" class="custom-checkbox"></div></td>
                                            
                                            <!-- <form action="{{ url_for('download') }}" method="post"> -->
                                            <td>
                                                <form method="post">
                                                    <button class="btn btn-success" type="submit" name="hdownloadbutton" style="margin-left: 2px;font-weight: bold;color: var(--bs-card-bg);">&nbsp;Scarica&nbsp;&nbsp;<i class="fas fa-file-download"></i>&nbsp;</button>
                                                    <!-- <input type="hidden" name="idJOB" value="{{ job[9] }}"> -->
                                                    <input type="hidden" name="datesim" value="{{ job[1] }}">
                                                    <input type="hidden" name="user" value="{{ user }}">
                                                    <input type="hidden" name="name_com" value="{{ job[4] }}">
                                                    <input type="hidden" name="codiceGisa" value="{{ job[8] }}">
                                                </form>
                                            </td>
                                            <!-- <td>
                                                <form method="post">
                                                    <input type="hidden" name="idJOB" value="{{ job[9] }}">
                                                    <button class="btn btn-warning" type="submit" name="hshowbutton" style="margin-left: 2px;font-weight: bold;color: var(--bs-card-bg);">&nbsp;Mostra&nbsp;<i class="fas fa-chalkboard-teacher"></i>&nbsp;</button>
                                                </form> 
                                            </td> -->
                                            <td>
                                                <form method="post">
                                                    <button class="btn btn-danger" type="submit" name="hdeletebutton" style="margin-left: 2px;font-weight: bold;color: var(--bs-card-bg);">&nbsp;Elimina&nbsp;<i class="fas fa-eraser"></i>&nbsp;</button>
                                                    <input type="hidden" name="idJOB" value="{{ job[9] }}">
                                                    <input type="hidden" name="datesim" value="{{ job[1] }}">
                                                    <input type="hidden" name="name_com" value="{{ job[4] }}">
                                                </form>
                                            </td>
                                            <td style="display: none;">{{job[10]}}</td> 
                                            <td style="display: none;">{{job[11]}}</td>                           
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    
                                    <!--
                                    <tfoot>
                                        <tr></tr>
                                    </tfoot>
                                    -->
                                </table>
                                <div class="pagination">
                                    {{ pagination.links }}
                                </div>
                            </div>
                            <div class="row"> 
                                <div class="col-md-6 align-self-center">
                                    <p id="dataTable_info" class="dataTables_info" role="status" aria-live="polite">{{ datainfo[0] }} - {{ datainfo[1] }} elementi di {{ datainfo[2] }} totali.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-12 col-xl-12">
                        <div class="card shadow mb-4" style="margin-left: 12px; margin-top: 20px; margin-right: 12px;">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="text-primary fw-bold m-0">Mappa interattiva</h6>
                        </div>
                        <div class="card-body">
                            <div width="100%" style="height: 520px;" id="map"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-12 col-xl-12" style="color: var(--bs-card-bg);background: var(--bs-card-cap-bg);" id="options_map">
                    <div class="card shadow mb-4" style="margin-left: 12px; margin-top: 9px; margin-right: 12px;">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="text-primary fw-bold m-0">Gestione simulazione e visualizzazione</h6>
                        </div>
                        <div class="card-body" style="height: 50%; margin-bottom: 0px;">
                            <input type="range" min="0" max="120" value="0" step="5" class="slider" id="myRange" list="list_values">
                            <p>Ora : <span id="demo"></span></p>
                            <p>Data : 
                                <select id="days_list">
                                </select>
                            </p>
                        </div>

                        <div class="card-body">
                            <button class="btn btn-primary btn-sm" id="bottoneSovrapposizione" style="width: 158.023px;height: 38px;font-weight: bold;background: var(--bs-teal);border-style: none;" onclick="sovraCheck()">Evoluzione</button>
                            <button class="btn btn-primary btn-sm" id="buffer500mt" style="width: 158.023px;height: 38px;font-weight: bold;background: var(--bs-teal);border-style: none;" onclick="bufferCheck500mt()">Buffer 500MT</button>
                            <button class="btn btn-primary btn-sm" id="buffer3km" style="width: 158.023px;height: 38px;font-weight: bold;background: var(--bs-teal);border-style: none;" onclick="bufferCheck3km()">Buffer 3KM</button>
                            <button class="btn btn-primary btn-sm" id="buttonHighlightCommons" style="width: 158.023px;height: 38px;font-weight: bold;background: var(--bs-teal);border-style: none;" onclick="highlightsCommon()">Evidenzia comuni</button>
                        </div> 
                    </div>
                </div>
            </div>
                    
            <div class="col-lg-12 col-xl-12" style="color: var(--bs-card-bg);background: var(--bs-card-cap-bg);" id="options_map">
                <div class="card shadow mb-4" style="margin-left: 12px; margin-top: 9px; margin-right: 12px;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="text-primary fw-bold m-0">Comuni Coinvolti</h6>
                    </div>
                    <div class="card-body" style="height: 50%; margin-bottom: 0px;">
                        <ul id="commons_list">
                            
                        </ul>
                    </div>
                </div>
            </div>

            <footer class="bg-white sticky-footer">
                <div class="container my-auto">
                    <div class="text-center my-auto copyright"><span>Copyright Â© Uniparthenope 2025</span></div>
                </div>
            </footer>

        </div>
                
        <a class="border rounded d-inline scroll-to-top" href="#page-top">
            <i class="fas fa-angle-up"></i>
        </a>
                
        <script src="{{ url_for('static', filename='bootstrap/js/bootstrap.min.js') }}"></script>
        <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
        <script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
        <script src="{{ url_for('static', filename='js/KML.js') }}"></script>
   
        <!-- Useful for date management for kml files. -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
        <!-- Useful library for generating a random color in hexadecimal. -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tinycolor/1.6.0/tinycolor.min.js"></script> 
    
        <script>

            document.getElementById('myRange').addEventListener("input", changeInput);

            var slider = document.getElementById("myRange");
            var output = document.getElementById("demo");
            output.innerHTML = slider.value;

            // Variables to manage button logic.
            var attivoBuffer3km = true;
            var flag_buffer3km = false;

            var attivoBuffer500mt = true;
            var flag_buffer500mt = false;

            var attivo=true;
            var flag_sovrapposizione = false;

            var attivoEvidenziaComuni = true;
            var flagEvidenziaComuni = false;

            // Variables to keep track of the lon and lat of the current simulation.
            var var_lon, var_lat;

            // Variables for dynamic map legend (.kml overlay).
            var legendElement, legendControl;
            var hourToLegend, colorToLegend;
            var previous_hour = 0;

            // Variables to manage the vector layer of buffers on the map.
            var vectorLayer_buffer500, vectorLayer_buffer3000;

            // Vector to manage the VectorLayers of the common polygons.
            var vectorLayersCommons = [];

            var base_global_path = "";

            var map = new ol.Map({
                target: 'map',
                layers: [
                    new ol.layer.Tile({
                        source: new ol.source.XYZ({
                            url: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png'
                        }),
                    }),
                ],
                view: new ol.View({
                    center: [0, 0],
                    zoom: 0,
                })
            });

            var fullScreenControl = new ol.control.FullScreen();
            map.addControl(fullScreenControl);

            var rotateMap = new ol.interaction.DragRotateAndZoom();
            map.addInteraction(rotateMap);

            // Section to highlight simulations that have not yet been completed.
            let table_body = document.getElementById("dataTable").getElementsByTagName("tbody")[0];

            if( table_body.rows.length > 0 ) {

                for( let i=0; i<table_body.rows.length; i++ ) {

                    if( table_body.rows[i].cells[14].textContent == '0' ) {
                        console.log("sim ancora in coda");
                        table_body.rows[i].cells[11].querySelector('#custom-checkbox').style.backgroundColor = "gray";
                    }
                } 
            }

            for(let i=0; i<table_body.rows.length; i++) {
                
                let name_user= "{{session['user']}}";
                let date_label = table_body.rows[i].cells[1].textContent;

                fetch('static/centroidi_comuni/centroidi_comuni.geojson')
                .then(response => response.json())
                .then(data => {

                    for (let feature of data.features) {
                        
                        if (feature.properties.COMUNE == table_body.rows[i].cells[4].textContent){

                            var municipality_code = feature.properties.COD_COM;
                            let url = "/static/smoketracer/" + name_user + "/" + date_label + "_" + municipality_code + "/" + date_label + "Z" + (parseInt(table_body.rows[i].cells[2].textContent)).toString().padStart(2, '0') + ".kml";

                            // Check if file exists.
                            fetch(url)
                            .then(response =>{
                                if(!response.ok) {

                                    if(table_body.rows[i].cells[15].textContent == '0') {
        
                                        table_body.rows[i].cells[11].querySelector('#custom-checkbox').style.backgroundColor = "gray";
                                        console.log("simulazione ancora in corso.")
                                    } else {
                                        table_body.rows[i].cells[11].querySelector('#custom-checkbox').style.backgroundColor = "red";
                                        console.log("simulazione non andata a buon fine.")
                                    }
                                } else {
                                    table_body.rows[i].cells[11].querySelector('#custom-checkbox').style.backgroundColor = "green";
                                    console.log("simulazione trovata.");
                                }
                                
                            })

                        }
                    }
                })
                .catch()
            }

            function search() {

                let text_input_search = document.getElementById('searchnamebar').value;
                let rows_match = []
                let tbody = document.getElementById("dataTable").getElementsByTagName("tbody")[0];
                
                if( tbody.rows.length > 0 ) {

                    for( let i=0; i<tbody.rows.length; i++ ) {

                        let field_search_of_row = tbody.rows[i].cells[13].textContent;

                        if( field_search_of_row.includes(text_input_search) ){

                            rows_match.push(tbody.rows[i]);
                            // console.log("occorrenza trovata");

                        }
                    }

                    rows_match.reverse().forEach(function(riga) {
                        tbody.insertBefore(riga, tbody.firstChild);
                        riga.classList.add('evidenziato');
                        setTimeout(function() {
                            riga.classList.remove('evidenziato');
                        }, 5000);
                    });      
                }
            }


            function changeInput() {

                output.innerHTML = this.value / 5;

                // Map cleaning section from previous layers.
                map.removeLayer(vectorLayer_buffer3000);
                map.removeLayer(vectorLayer_buffer500);
                
                // Removes all layers (relating to the municipality polygons) from the map.
                for( let layer of vectorLayersCommons )
                    map.removeLayer(layer);
                
                // Vector cleaning that tracks the layers related to the polygons of the municipalities.
                vectorLayersCommons = [];
                
                let selected_choice = document.getElementById('days_list');
                let value_selected_choice = selected_choice.options[selected_choice.selectedIndex].value;
                let value_without_char = value_selected_choice.replace(/-/g, "");


                let selected_hour = slider.value / 5;
                let selected_hour_str = selected_hour.toString();
                if( selected_hour < 10 ) {
                    selected_hour_str = selected_hour_str.padStart(2, '0')
                }

                hourToLegend = parseInt(selected_hour_str);
            
                // Create the style (color change) for the lines of the .kml
                function changeKMLColor(feature, color) {
                    feature.setStyle(new ol.style.Style({
                        stroke: new ol.style.Stroke({
                            color: color,
                            width: 2
                        })
                    }));
                }
                
                // Dynamically create kml file path based on user-set parameters.
                let url_var = base_global_path + value_without_char + "Z" + selected_hour_str + ".kml"; 


                // Loading kml file into a vector-layer.
                let targetVectorLayer = new ol.layer.Vector({
                    source: new ol.source.Vector({
                        url: url_var,
                        format: new ol.format.KML(),
                    })
                });

                // Updated color variable for legend.
                let new_color = tinycolor.random().toHexString();
                colorToLegend = new_color;
          

                // Effective color change to vector features in kml.
                targetVectorLayer.getSource().once('change', function(event) {
                    if (targetVectorLayer.getSource().getState() === 'ready') {
                            var features = targetVectorLayer.getSource().getFeatures();
                            color = new_color;
                            // console.log("colorToLegend : ", colorToLegend);

                            features.forEach(function(feature) {
                                changeKMLColor(feature, color);
                            });
                        }
                    });
                    
                                
                // Section that implements the extraction of municipalities based on the .kml of the selected time.
                let var_commons_list = document.getElementById('commons_list')
                var_commons_list.textContent = '';
    
                
                fetch('extractCommons?path_kml=' + '/home/fumi2/FUMI2/' + url_var)
                .then(response => {

                    if( response.status == 500 || response.status == 404 ) {
                        document.getElementById('myRange').style.backgroundColor = "red";
                    } else { 
                        document.getElementById('myRange').style.backgroundColor = "#d3d3d3";
                    }

                    return response.json();
                }) 
                .then(data => {

                    let wkt_strings_box_extracted_commons = [];
                    vectorLayersCommons = [];

                    for( let elem of data ) {

                        let newCommon = document.createElement('li')
                        newCommon.textContent = elem[1].toString()
                        var_commons_list.appendChild(newCommon)

                        wkt_strings_box_extracted_commons.push(elem[2]);

                    }
 
                    // Box coordinates wkt string manipulation section.
                    for( let elem of wkt_strings_box_extracted_commons ) {

                        let wktFormat = new ol.format.WKT();
                        let polygonGeometry = wktFormat.readGeometry(elem);
                        let polygonFeature = new ol.Feature(polygonGeometry);

                        //  The coordinates are stored in EPSG:4326 (due to the nature of mongodb places), I convert to EPSG:3857
                        polygonGeometry = polygonGeometry.transform('EPSG:4326', 'EPSG:3857');

                        let vectorSource = new ol.source.Vector({
                            features: [polygonFeature]
                        });

                        // Create the vector layer with a fill color
                        let vectorLayer = new ol.layer.Vector({
                            source: vectorSource,
                            style: new ol.style.Style({
                                fill: new ol.style.Fill({
                                    color: 'rgba(255, 0, 0, 0.2)'
                                }),
                                stroke: new ol.style.Stroke({
                                    color: 'red',
                                    width: 0.5
                                })
                            })
                        });                        
                    
                        if( flagEvidenziaComuni ) 
                            // Adds vectorLayers to the map.
                            map.addLayer(vectorLayer);
                        else 
                            // Adds the extracted polygons' vectorLayers to the array that keeps track of those layers for the user.
                            vectorLayersCommons.push(vectorLayer);
                    }
                })
                .catch(error => console.error('Errore estrazione comuni dal file .kml : ', error))
                
                
                                 
                if(flag_sovrapposizione==false){

                    // Cleans the map from previous .kml.
                    var layers = map.getLayers().getArray();
                    layers.forEach(function(layer) {
                    if (layer instanceof ol.layer.Vector) {
                            layer.getSource().clear();
                        }
                    });

                    // Clears the legend from the map in case the overlap was previously 'True'.
                    map.removeControl(legendControl);

                    // Adds the simulation .kml (layer) to the map.
                    map.addLayer(targetVectorLayer); 

                    

                } else { 

                    // In case the user goes back with the time, the last layer inserted on the map and in the legend must be deleted. 

                    if ( (parseInt(selected_hour_str)) <= previous_hour ) {

                        // remove the last inserted layer
                        let layers_map = map.getLayers().getArray();
                        map.removeLayer(layers_map[layers_map.length-1]);

                        // remove the last entry in the legend 
                        let array_lines_html_string = (legendElement.innerHTML).split('\n');
                        let new_string_html = " ";

                        for(let i=0; i<array_lines_html_string.length-2; i++) {
                            console.log("line : ", array_lines_html_string[i]);
                            new_string_html += array_lines_html_string[i] + '\n';
                        }

                        legendElement.innerHTML = new_string_html;
                        legendControl = new ol.control.Control({
                            element: legendElement
                        });

                        // Add updated legend to map 
                        map.addControl(legendControl);
            
                        
                    } else {
                    
                        // Add the current simulation time field to the legend.
                        let hour_legend = (hourToLegend.toString()).padStart(2, '0') + ':00 UTC';
                        legendElement.innerHTML = legendElement.innerHTML + ` <div><span style="background-color: ` + new_color.toString() + `; width: 20px; height: 20px; display: inline-block;"></span> ` + hour_legend  + ` </div> \n`;

                        legendControl = new ol.control.Control({
                            element: legendElement
                        });

                        // Add updated legend to map. 
                        map.addControl(legendControl);

                        // Add the .kml (layer) to the map.
                        map.addLayer(targetVectorLayer);  
                        
                    }
                }

                // Update the previous time based on the selected time.
                previous_hour = parseInt(hourToLegend)-1;

                // Control section of layers added to the map
                if(flag_buffer3km)
                    map.addLayer(vectorLayer_buffer3000);
                if(flag_buffer500mt)
                    map.addLayer(vectorLayer_buffer500);
            }


            function sovraCheck() {

                attivo = !attivo;
                var bottone = document.getElementById("bottoneSovrapposizione");

                if (attivo) {

                    bottone.classList.remove("evidenziato");
                    bottone.style.color = "white";
                    // console.log("SOVRAPPOSIZIONE : disattivato");
                    flag_sovrapposizione = false;
                    map.removeControl(legendControl);

                } else {

                    bottone.classList.add("evidenziato");
                    bottone.style.color = "black";
                    // console.log("SOVRAPPOSIZIONE : attivato");
                    flag_sovrapposizione = true;

                    let hour_legend = ((hourToLegend).toString()).padStart(2, '0') + ':00 UTC'
                    legendElement = document.createElement('div');
                    legendElement.className = 'ol-legend';
                    legendElement.innerHTML = `
                        <h4>Legenda</h4>
                        <div><span style="background-color: ` + colorToLegend.toString() + `; width: 20px; height: 20px; display: inline-block;"></span> ` + hour_legend.toString() + ` </div> \n`;

                    // Create a custom control for the legend.
                    legendControl = new ol.control.Control({
                        element: legendElement
                    });

                    // Add map legend control.
                    map.addControl(legendControl);

                }
            }
            
            function bufferCheck3km() {

                attivoBuffer3km = !attivoBuffer3km;
                let bottone = document.getElementById("buffer3km");
                
                if (attivoBuffer3km) {
                    bottone.classList.remove("evidenziato");
                    bottone.style.color = "white";
                    console.log("BUFFER [3km] : disattivato");
                    flag_buffer3km = false;
                    map.removeLayer(vectorLayer_buffer3000);

                } else {
                    bottone.classList.add("evidenziato");
                    bottone.style.color = "black";
                    console.log("BUFFER [3km] : attivato");
                    flag_buffer3km = true;

                    let lon = var_lon;
                    let lat = var_lat;
                    let center = [lon, lat]; // for test
                    let radius = 3000;

                    let circle = new ol.geom.Circle(ol.proj.fromLonLat(center), radius);
                    let circleFeature = new ol.Feature(circle);
                    let circleStyle = new ol.style.Style({
                        stroke: new ol.style.Stroke({
                            color: 'black',
                            width: 1
                        }),
                    });
                    circleFeature.setStyle(circleStyle);

                    // Create an instance of ol.source.Vector to contain the circle.
                    let vectorSource = new ol.source.Vector({
                        features: [circleFeature]
                        });

                    // Create an instance of ol.layer.Vector to display the circle on the map.
                    vectorLayer_buffer3000 = new ol.layer.Vector({
                        source: vectorSource
                        });

                    map.addLayer(vectorLayer_buffer3000);
                    console.log("BUFFER [3km] : Added to map")

                }
            }


            function bufferCheck500mt() {

                attivoBuffer500mt = !attivoBuffer500mt;
                let bottone = document.getElementById("buffer500mt");

                if (attivoBuffer500mt) {

                    bottone.classList.remove("evidenziato");
                    bottone.style.color = "white";
                    console.log("BUFFER [500mt] : disattivato");
                    flag_buffer500mt = false;
                    map.removeLayer(vectorLayer_buffer500);

                } else {

                    bottone.classList.add("evidenziato");
                    bottone.style.color = "black";
                    // console.log("BUFFER [500mt]: attivato");
                    flag_buffer500mt = true;

                    let lon = var_lon;
                    let lat = var_lat;
                    let center = [lon, lat]; // for test
                    let radius = 500;

                    let circle = new ol.geom.Circle(ol.proj.fromLonLat(center), radius);
                    let circleFeature = new ol.Feature(circle);
                    let circleStyle = new ol.style.Style({
                        stroke: new ol.style.Stroke({
                            color: 'black',
                            width: 1
                        }),
                    });
                    circleFeature.setStyle(circleStyle);

                    // Create an instance of ol.source.Vector to contain the circle.
                    let vectorSource = new ol.source.Vector({
                        features: [circleFeature]
                        });

                    // Create an instance of ol.layer.Vector to display the circle on the map.
                    vectorLayer_buffer500 = new ol.layer.Vector({
                        source: vectorSource
                        });

                    map.addLayer(vectorLayer_buffer500);
                    //console.log("BUFFER [3km] : Added to map")
                }
            }
            
            
            function highlightsCommon() {

                attivoEvidenziaComuni = !attivoEvidenziaComuni;
                let buttonHighlightsCommons = document.getElementById('buttonHighlightCommons');
                // console.log("attivoEvidenzia : ", attivoEvidenziaComuni);

                if(attivoEvidenziaComuni) {

                    buttonHighlightsCommons.classList.remove("evidenziato");
                    buttonHighlightsCommons.style.color = "white";
                    //console.log("Highlights Commons : disattivato");
                    flagEvidenziaComuni = false;

                    for( let layer of vectorLayersCommons ) 
                        map.removeLayer(layer);

                    // Cleans the map from previous .kml.
                    var layers = map.getLayers().getArray();

                } else {
                
                    buttonHighlightsCommons.classList.add("evidenziato");
                    buttonHighlightsCommons.style.color = "black";
                    //console.log("Highlights Commons : attivato");
                    flagEvidenziaComuni = true;

                    for( let layer of vectorLayersCommons ) 
                        map.addLayer(layer);
                    
                }

            }
            
            
            function evidenziaRiga(riga) {

                if( riga.classList.contains('evidenziato') )
                    return;

                // ---------------- START MAP CLEANING SECTION ---------------------------

                // Cleans the array of layers (places polygons) from the previous simulation.
                vectorLayersCommons = [];
                console.log("vectorLayersCommons pulito !");

                // Initialize flags for button logic.
                flag_buffer3km = false;
                attivoBuffer3km = true;
                document.getElementById("buffer3km").classList.remove('evidenziato');

                flag_buffer500mt = false;
                attivoBuffer500mt = true;
                document.getElementById("buffer500mt").classList.remove('evidenziato');

                flag_sovrapposizione = false;
                attivo = true;
                document.getElementById("bottoneSovrapposizione").classList.remove('evidenziato');

                flagEvidenziaComuni = false;
                attivoEvidenziaComuni = true;
                document.getElementById('buttonHighlightCommons').classList.remove('evidenziato');

                // Cleans the legend. 
                map.removeControl(legendControl);

                // Clears the layers map of the previous simulation.  
                var layers = map.getLayers(); 
                layers.forEach(function(layer) {
                if (layer instanceof ol.layer.Vector) {
                        layer.getSource().clear();
                    }
                });

                // Clears the name field of the municipalities extracted from the previous simulation.
                var ul_common_list = document.getElementById('commons_list')
                if( ul_common_list.children.length > 0 ) {
                    for( let i=0; i<ul_common_list.children.length; i++) {
                        ul_common_list.removeChild(ul_common_list.children[i])
                    }
                }

                // Removes the highlight from the row from all rows in the table except the one corresponding to the current simulation.
                var righe = document.querySelectorAll('tr');
                righe.forEach(function(row) {
                    row.classList.remove('evidenziato');
                });
                
                // -------------------------END OF MAP CLEANING SECTION --------------------------------------------
            

                var_lon = parseFloat(riga.cells[5].textContent);
                var_lat = parseFloat(riga.cells[6].textContent); 
                var coordinate = ol.proj.fromLonLat([var_lon, var_lat]);

                // Set the lon and lat of the simulation center 
                map.getView().setCenter(coordinate);
                map.getView().setZoom(11);


                let name_user = "{{session['user']}}";
                let date_label = riga.cells[1].textContent;

                fetch('static/centroidi_comuni/centroidi_comuni.geojson')
                .then(response => response.json())
                .then(data => {

                    for (let feature of data.features) {
                        
                        if (feature.properties.COMUNE == riga.cells[4].textContent){

                            var municipality_code = feature.properties.COD_COM;
                            let url = "/static/smoketracer/" + name_user + "/" + date_label + "_" + municipality_code + "/" + date_label + "Z" + (parseInt(riga.cells[2].textContent)).toString().padStart(2, '0') + ".kml";
                            
                            // Check if file exists.
                            fetch(url)
                            .then(response =>{
                                if(response.ok) 
                                    riga.classList.add('evidenziato');
                            })
                            
                            
                            base_global_path = "/static/smoketracer/" + name_user + "/" + date_label + "_" + municipality_code + "/"
                            
                            hourToLegend = (parseInt(riga.cells[2].textContent));
                            previous_hour = parseInt(riga.cells[2].textContent);

                            var targetVectorLayer = new ol.layer.Vector({
                                source: new ol.source.Vector({
                                    url: url,
                                    format: new ol.format.KML()
                                })
                            });

                            map.addLayer(targetVectorLayer);

                            // The first plot of isolines will always be red.
                            colorToLegend = "red"

                            let var_commons_list = document.getElementById('commons_list')
                            let wkt_strings_box_extracted_commons = [];                         
                            
                            fetch('extractCommons?path_kml=' + '/home/fumi2/FUMI2' + url)
                            .then(response => response.json())
                            .then(data => {

                                console.log("data : ",data);
                                for (let elem of data) {
                                    // console.log("Common : ", elem[1]);
                                    let newCommon = document.createElement('li');
                                    newCommon.textContent = elem[1].toString();
                                    var_commons_list.appendChild(newCommon);

                                    wkt_strings_box_extracted_commons.push(elem[2]);
                                }

                               
                                // WKT string manipulation section of box coordinates.
                                for( let elem of wkt_strings_box_extracted_commons) {

                                    let wktFormat = new ol.format.WKT();
                                    let polygonGeometry = wktFormat.readGeometry(elem);

                                    // Creates a feature that represents the polygon.
                                    let polygonFeature = new ol.Feature(polygonGeometry);
                                    // The coordinates are stored in EPSG:4326 (due to the nature of mongodb places), I convert to EPSG:3857. 
                                    polygonGeometry = polygonGeometry.transform('EPSG:4326', 'EPSG:3857');

                                    // Create the source for the vector layer.
                                    let vectorSource = new ol.source.Vector({
                                        features: [polygonFeature]
                                    });

                                    // Create the vector layer with a fill color
                                    let vectorLayer = new ol.layer.Vector({
                                        source: vectorSource,
                                        style: new ol.style.Style({
                                            fill: new ol.style.Fill({
                                                color: 'rgba(255, 0, 0, 0.2)' 
                                            }),
                                            stroke: new ol.style.Stroke({
                                                color: 'red', 
                                                width: 0.5
                                            })
                                        })
                                    });

                                    // Adds the vector Layers of the extracted polygons to the array that keeps track of those layers for the user.
                                    vectorLayersCommons.push(vectorLayer);
                                }
                            
                                
                            })
                            .catch(error => console.error('Errore estrazione comuni dal file .kml : ', error))
                            
                        }                        
                    }
                })
                .catch(error => console.error('Errore durante il recupero del file:', error));
                
            
                document.getElementById('myRange').value = (parseInt(riga.cells[2].textContent) * 5);
                document.getElementById('demo').textContent = riga.cells[2].textContent;

                let data_standard = moment(date_label);
                let data_formatted = data_standard.format('YYYY-MM-DD');
                let int_durata = parseInt(riga.cells[3].textContent);

                let selectElement = document.getElementById('days_list');
                while (selectElement.options.length > 0) {
                    selectElement.remove(0);
                }

                let object_option = document.createElement('option');
                object_option.value = data_formatted;
                object_option.text = data_formatted;
                document.getElementById("days_list").appendChild(object_option);

                if( int_durata > 24) {
                    let tot_giorni = int_durata / 24;
                    for(let k=1; k<=tot_giorni; k++) {
                        var_object = document.createElement('option');
                        let next_day = (data_standard.add(1, 'day')).format('YYYY-MM-DD');
                        var_object.value = next_day;
                        var_object.text = next_day;
                        document.getElementById('days_list').appendChild(var_object);             
                    }
                }  
            }
        
        </script>
</body>
</html>