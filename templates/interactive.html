<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Simulazione Singola</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap/css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i&amp;display=swap">
    <link rel="stylesheet" href="{{ url_for('static', filename='fonts/fontawesome-all.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='fonts/ionicons.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap/css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/css/Login-Form-Basic-icons.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/VentasPro-Login.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script> <!-- utile per la gestione della data per i file kml -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinycolor/1.6.0/tinycolor.min.js"></script> <!-- libreria utile per la generazione di un colore randomico in esadecimale -->
    <!-- <link rel="stylesheet" href="http://unpkg.com/leaflet@1.4.0/dist/leaflet.css" /> -->
    <!-- <script src="http://unpkg.com/leaflet@1.4.0/dist/leaflet.js"></script> -->
    
    <style>

    .bottone {
        width: 100px;
        height: 40px;
        margin: 5px; /* Aggiunto un margine tra i bottoni per separarli */
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px; /* Bordo arrotondato per i bottoni */
        font-size: 13px;
        cursor: pointer;
        align-items: center;
    }

    .bottone:hover {
        background-color: #ffcc00; 
    }

    .bottone:active {
        background-color: #ffea00; 
    }

    .disattivato {
        opacity: 0.5; 
        cursor: not-allowed; 
    }

    .slidecontainer {
    width: 100%;
    }

    .slider {
    -webkit-appearance: none;
    width: 100%;
    height: 15px;
    border-radius: 5px;
    background: #d3d3d3;
    outline: none;
    opacity: 0.7;
    -webkit-transition: .2s;
    transition: opacity .2s;
    }

    .slider:hover {
    opacity: 1;
    }

    .slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 25px;
    height: 25px;
    border-radius: 50%;
    background: #04AA6D;
    cursor: pointer;
    }

    .slider::-moz-range-thumb {
    width: 25px;
    height: 25px;
    border-radius: 50%;
    background: #04AA6D;
    cursor: pointer;
    }

    </style>
</head>

<body id="page-top" onload="controlKmlOnLoad()">
    <div id="wrapper">
        <nav class="navbar navbar-dark align-items-start sidebar sidebar-dark accordion bg-gradient-primary p-0">
            <div class="container-fluid d-flex flex-column p-0">
                <a class="navbar-brand d-flex justify-content-center align-items-center sidebar-brand m-0" href="#"><img style="width: 32px;height: 33px;" src="{{ url_for('static', filename='/img/Regione_Campania-logo-0A3FAC65C4-seeklogo.com.png') }}">
                    <div class="sidebar-brand-icon rotate-n-15"></div>
                    <div class="sidebar-brand-text mx-3"><span>FUMI2</span></div>
                </a>
                <hr class="sidebar-divider my-0">
                <ul class="navbar-nav text-light" id="accordionSidebar">
                    <li class="nav-item"><a class="nav-link" href="dashboard"><i class="fas fa-terminal"></i><span style="color: var(--bs-accordion-bg);">Dashboard</span></a></li>
                    <li class="nav-item"><a class="nav-link" href="interattivo"><i class="fas fa-eye"></i><span style="color: var(--bs-accordion-bg);">Simulazione singola</span></a></li>
                    <li class="nav-item"><a class="nav-link" href="coda"><i class="fas fa-list"></i><span style="color: var(--bs-accordion-bg);">Simulazioni multiple</span></a></li>
                    <li class="nav-item"><a class="nav-link" href="storico"><i class="fas fa-table"></i><span style="color: var(--bs-accordion-bg);">Storico</span></a></li>
                    <li class="nav-item"><a class="nav-link" href="profilo"><i class="far fa-user-circle" style="border-color: rgba(255, 255, 255, 0.3);border-top-color: rgba\(255,;border-right-color: 255,;border-bottom-color: 255,;border-left-color: 0.3\);"></i><span style="color: var(--bs-accordion-bg);">Profilo</span></a></li>
                    <li class="nav-item"></li>
                </ul>
                <div class="text-center d-none d-md-inline"><button class="btn rounded-circle border-0" id="sidebarToggle" type="button"></button></div>
            </div>
        </nav>
        <div class="d-flex flex-column" id="content-wrapper">
            <div id="content">
                <nav class="navbar navbar-light navbar-expand bg-white shadow mb-4 topbar static-top">
                    <div class="container-fluid"><button class="btn btn-link d-md-none rounded-circle me-3" id="sidebarToggleTop" type="button"><i class="fas fa-bars"></i></button><small class="form-text fs-4 fw-semibold" style="width: 2348.234px;">Benvenuto! La tua&nbsp;ultima visita risale al: {{ last_access }}&nbsp;</small>
                        <ul class="navbar-nav flex-nowrap ms-auto">
                            <div class="d-none d-sm-block topbar-divider"></div>
                        </ul><small class="form-text" style="margin-left: 0px;width: 450.1641px; font-weight:bold"><h4><b>{{ user }}</b></h4></small><a href="{{ url_for('logout') }}" class="btn btn-primary" style="white-space: nowrap; text-align: center;">Log Out</a>
                    </div>
                </nav>

                <div class="container-fluid" style="width: auto;height: auto;">

                    <form method="POST" novalidate>

                        <div class="d-sm-flex justify-content-between align-items-center mb-4" style="border-style: none;">
                            <h3 class="text-dark mb-0">Nuova Simulazione</h3>
                        </div>

                        <div class="row">


                            <div class="col">
                                <div class="row">
                                    <div class="col" style="margin-bottom: 20px;">
                                        <div class="card shadow border-start-primary py-2" style="margin-bottom: 10px;width: auto;height: auto;">
                                            <div class="card-body">
                                                <div class="row align-items-center no-gutters">
                                                    <div class="col me-2">
                                                        <div class="text-uppercase text-primary fw-bold text-xs mb-1"><span>DESCRIZIONE</span></div><input type="text" name="area" id="area_dash" style="width: 162px;" required>
                                                        <div class="text-dark fw-bold h5 mb-0"></div>
                                                    </div>
                                                    <div class="col-auto"><i class="fas fa-chart-area fa-2x text-gray-300"></i></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card shadow border-start-primary py-2">
                                            <div class="card-body">
                                                <div class="row align-items-center no-gutters">
                                                    <div class="col me-2">
                                                        <div class="text-uppercase text-primary fw-bold text-xs mb-1"><span style="color: var(--bs-purple);">Longitudine</span></div>
                                                        <div class="text-dark fw-bold h5 mb-0"><span><input type="number" name="long" step="any" id="long_dash" style="width: 160px;" required></span></div>
                                                    </div>
                                                    <div class="col-auto"><i class="icon ion-ios-world-outline fa-2x text-gray-300"></i></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            

                            <div class="col">
                                <div class="card shadow border-start-success py-2" style="margin-bottom: 10px;height: 100.8047px;">
                                    <div class="card-body">
                                        <div class="row align-items-center no-gutters">
                                            <div class="col me-2">
                                                <div class="text-uppercase text-success fw-bold text-xs mb-1"><span>DATA</span></div>
                                                <div class="text-dark fw-bold h5 mb-0"><span><input id="date_dash" type="date" name="data" style="width: 168px;" required></span></div>
                                            </div>
                                            <div class="col-auto"><i class="far fa-calendar-alt fa-2x text-gray-300"></i></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card shadow border-start-success py-2">
                                    <div class="card-body">
                                        <div class="row align-items-center no-gutters">
                                            <div class="col me-2">
                                                <div class="text-uppercase text-success fw-bold text-xs mb-1"><span style="color: var(--bs-indigo);">latitudine</span></div><input type="number" step="any" name="lat" id="lat_dash" style="width: 160px;" required>
                                                <div class="text-dark fw-bold h5 mb-0"><span></span></div>
                                            </div>
                                            <div class="col-auto"><i class="icon ion-ios-world fa-2x text-gray-300"></i></div>
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <div class="col">
                                <div class="card shadow border-start-info py-2" style="margin-bottom: 10px;height: 100.805px;">
                                    <div class="card-body">
                                        <div class="row align-items-center no-gutters">
                                            <div class="col me-2">
                                                <div class="text-uppercase text-warning fw-bold text-xs mb-1"><span style="color: var(--bs-red);">ora</span></div>
                                                <div class="text-dark fw-bold h5 mb-0">

                                                    <select name="hours" class="Input">
                                                        {% for hour in hours %}
                                                        <option value="{{ hour }}">{{ hour }}</option>
                                                        {% endfor %}
                                                    </select><br><br>

                                                </div>
                                            </div>
                                            <div class="col-auto"><i class="far fa-clock fa-2x text-gray-300"></i></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card shadow border-start-info py-2">
                                    <div class="card-body">
                                        <div class="row align-items-center no-gutters">
                                            <div class="col me-2">
                                                <div class="text-uppercase text-info fw-bold text-xs mb-1"><span style="color: var(--bs-code-color);">Temperatura</span></div><input type="number" name="temp" id="temp_dash" style="width: 160px;" required>
                                                <div class="row g-0 align-items-center">
                                                    <div class="col-auto">
                                                        <div class="text-dark fw-bold h5 mb-0 me-3"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-auto"><i class="fas fa-temperature-high fa-2x text-gray-300"></i></div>
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <div class="col">
                                <div class="card shadow border-start-warning py-2" style="margin-bottom: 10px; height: 100.805px;">
                                    <div class="card-body">
                                        <div class="row align-items-center no-gutters">
                                            <div class="col me-2">
                                                <div class="text-uppercase text-warning fw-bold text-xs mb-1"><span>DURATA</span></div><input type="number" min="1" name="durata" id="duration_dash" style="width: 160px;" required>
                                                <div class="text-dark fw-bold h5 mb-0"></div>
                                            </div>
                                            <div class="col-auto"><i class="fas fa-long-arrow-alt-right fa-2x text-gray-300"></i></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="card shadow border-start-info py-2">
                                    <div class="card-body">
                                        <div class="row align-items-center no-gutters">
                                            <div class="col me-2">
                                                <div class="text-uppercase text-info fw-bold text-xs mb-1"><span style="color: var(--bs-code-color);">Codice GISA</span></div><input type="text" name="codice_gisa" id="codice_gisa" style="width: 160px;">
                                                <div class="row g-0 align-items-center">
                                                    <div class="col-auto">
                                                        <div class="text-dark fw-bold h5 mb-0 me-3"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-auto"><i class="fas fa-barcode fa-2x text-gray-300"></i></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col">
                                <div class="card shadow border-start-warning py-2" style="margin-bottom: 10px; height: 100.805px;">
                                    <div class="card-body">
                                        <div class="row align-items-center no-gutters">
                                            <div class="col me-2">
                                                <div class="text-uppercase text-success fw-bold text-xs mb-1">
                                                    <span style="color: var(--bs-indigo);">COMUNI</span>
                                                </div>
                                                <input type="text" name="comune" id="comune_label" style="width: 160px;" list="comuni_list" required>
                                                <datalist id="comuni_list">
                                                </datalist>
                                                <div class="text-dark fw-bold h5 mb-0"><span></span></div>
                                            </div>
                                            <!-- <div class="col-auto"><i class="icon ion-ios-world fa-2x text-gray-300"></i></div> -->
                                        </div>
                                    </div>
                                </div>
                            </div>


                        </div>  <!-- end row -->


                        <div class="row" style="margin-bottom: 25px;">
                            <div class="col" style="width: auto;margin-left: auto;margin-right: auto;text-align: center;">
                                <button class="btn btn-danger btn-lg" type="submit" name="dresetmap" style="margin-left: 5px;font-weight: bold;width: auto;height: auto;margin-right: 8px;">
                                    &nbsp;Reset&nbsp; <i class="fas fa-eraser"></i> &nbsp; &nbsp;
                                </button>
                                <button class="btn btn-success btn-lg" type="submit" name="generate" id="start-button" style="margin-left: 8px; font-weight: bold;width: auto;height: auto;">&nbsp;Genera&nbsp;<i class="fas fa-globe-americas"></i>&nbsp;</button>
                            </div>
                        </div>
                    </form>

                    <!--
                    <div class="row">
                        <p>{% for mesg in get_flashed_messages() %}
                            <div class="alert alert-danger text-center"><b>{{ mesg }}</b></div>
                            {% endfor %}</p>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div class="row">
                                <div class="col"><small class="form-text" style="font-weight: bold;">{{ info_str }}</small>
                                    <div class="progress" style="margin-bottom: 25px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressbar" role="progressbar" style="width: \{\{ progress }\}\;\" aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100" >{{ progress }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-12 col-xl-12">
                            
                            <table class="table">
                                <tr>
                                    <th>DATA</th>
                                    <th>ORA INIZIO SIMULAZIONE</th>
                                    <th>PROGRESSO/ORA SIMULAZIONE</th>
                                </tr>
                                <tr>
                                    <td id="data_data"></td>
                                    <td id="data_ora_inizio"></td>
                                    <td id="data_ora"></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    -->
                   
                    <div class="row">

                        <div class="col-lg-12 col-xl-12">
                            <div class="card shadow mb-4">
                                <div class="card-body"> 
                                    <div id="map" style="height: 500px; margin: 0;"></div>
                                    <!--
                                    <div class="slidecontainer" id="div_slider" style="visibility: hidden;">
                                        <input type="range" min="0" max="120" value="0" step="5" class="slider" id="myRange" list="list_values">
                                        <p>Ora : <span id="demo"></span></p>
                                        <p>Data : 
                                            <select id="days_list">
                                            </select>
                                        </p>
                                    </div>
                                    <button id="bottoneSovrapposizione" class="bottone" onclick="sovraCheck()">Sovrapposizione</button>
                                    <button id="buffer3km" class="bottone" onclick="bufferCheck3km()">Buffer 3km</button>
                                    <button id="buffer500mt" class="bottone" onclick="bufferCheck500mt()">Buffer 500mt</button>
                                    -->
                                    <!--
                                    <div width="100%" height="400" style="height: 520px;" id="map"></div>
                                    <input type="hidden" id="update" , value="{{ update }}">
                                    <input type="hidden" id="kmlpath" , value="{{ kmlpath }}">

                                    <script>
                                        function loadKmlToMap(kmlFilePath) {

                                            // If the update value is true, we call the updateProgress funct
                                            if (document.getElementById("update").value==="True") {
                                                console.log("starting update")
                                                startUpdate()
                                            } else {
                                                stopUpdate()
                                            }

                                            // IF kmlFilePath is undefined
                                            if (kmlFilePath == null) {
                                                // display the kml path fetched froom a cookie
                                                kmlFilePath = document.getElementById("kmlpath").value
                                            }

                                            var container = L.DomUtil.get('map');
                                            if(container != null){
                                                container._leaflet_id = null;
                                            }

                                            // Create new Leaflet map
                                            const map = new L.Map('map', {
                                              attributionControl: false,
                                              center: new L.LatLng(40.833189, 14.298180),
                                              zoom: 11,
                                              dragging: true
                                            });
                                          
                                            // Add OpenStreetMap tile layer to map
                                            const osm = new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
                                            map.addLayer(osm);
                                          
                                            // Construct file path
                                            const tmp_path = "{{ url_for('static', filename='TMP') }}";
                                            const filepath = tmp_path.replace('TMP', kmlFilePath);
                                          
                                            // Fetch KML file
                                            return fetch(filepath, { mode: 'cors' })
                                              .then(res => res.text())
                                              .then(kmltext => {
                                                // Create new KML overlay
                                                const parser = new DOMParser();
                                                const kml = parser.parseFromString(kmltext, 'text/xml');
                                                const track = new L.KML(kml);
                                          
                                                // Add KML overlay to map
                                                map.addLayer(track);
                                          
                                                // Fit map bounds to KML overlay
                                                const bounds = track.getBounds();
                                                map.fitBounds(bounds);
                                          
                                                // Resolve with loaded KML data
                                                return kml;
                                              });
                                          }
                                    </script>
                                -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-7 col-xl-7" style="color: var(--bs-card-bg);background: var(--bs-card-cap-bg); visibility: hidden;" id="options_simulation">
                            <div class="card shadow mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="text-primary fw-bold m-0">Info Operazione Sottomessa</h6>
                                </div>
                                <!-- 192px -->
                                <div class="card-body" style="height: 100%; margin-bottom: 0px;">
                                    <div class="table-responsive">

                                        <table class="table", id="state-table">
                                        
                                            <thead>
                                                <tr>
                                                    <th>Identificativo</th>
                                                    <th>Stato</th>
                                                    <th>Azioni</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>75242</td>
                                                    <td>TERMINATA</td>
                                                    <td>
                                                        <form method="POST">
                                                                <button class="btn btn-danger" id="icancelbtn" type="submit" name="icancel" style="margin-left: 2px;font-weight: bold;"><i class="fas fa-trash"></i></button>
                                                                <!-- <button class="btn btn-danger" id="icancelbtn" type="submit" name="icancel" style="margin-left: 2px;font-weight: bold;" disabled><i class="fas fa-trash"></i></button> -->
                                                        </form>
                                                    </td>
                                                </tr>
                                                <tr></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table", id="info-table">
                                        
                                            <thead>
                                            
                                                <tr>
                                                    <th>Area</th>
                                                    <th>Data</th>
                                                    <th>Ora</th>
                                                    <th>Durata</th>
                                                    <th>Long</th>
                                                    <th>Lat</th>
                                                    <th>Temp</th>
                                                    <th>Codice GISA</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>Napoli</td>
                                                    <td>19/03/2024</td>
                                                    <td>00</td>
                                                    <td>10</td>
                                                    <td>14.32745</td>
                                                    <td>40.84294</td>
                                                    <td>1200</td>
                                                    <td> // </td>
                                                </tr>
                                                <tr></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>  


                        <div class="col-lg-5 col-xl-5" style="color: var(--bs-card-bg);background: var(--bs-card-cap-bg); visibility: hidden;" id="options_map">
                            <div class="card shadow mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="text-primary fw-bold m-0">Gestione simulazione e visualizzazione</h6>
                                </div>
                                
                                <div class="card-body" style="height: 50%; margin-bottom: 0px;">
                                    <input type="range" min="0" max="120" value="0" step="5" class="slider" id="myRange" list="list_values">
                                    <p>Ora : <span id="demo"></span></p>
                                    <p>Data : 
                                        <select id="days_list">
                                        </select>
                                    </p>
                                </div>

                                <div class="card-body" style="height: 50%; margin-bottom: 0px;">
                                    <button id="bottoneSovrapposizione" class="bottone" onclick="sovraCheck()">Sovrapposizione</button>
                                    <button id="buffer3km" class="bottone" onclick="bufferCheck3km()">Buffer: 3km</button>
                                    <button id="buffer500mt" class="bottone" onclick="bufferCheck500mt()">Buffer: 500mt</button>
                                </div>
                            </div>
                        </div>

                        
                        
                        <!--
                        <div class="col-lg-5 col-xl-5" id="operations_maps">
                            <div class="col-lg-12 col-xl-12">
                                <div class="card shadow mb-4">
                                     <div class="slidecontainer" id="div_slider">  
                                    <input type="range" min="0" max="120" value="0" step="5" class="slider" id="myRange" list="list_values">
                                    <p>Ora : <span id="demo"></span></p>
                                    <p>Data : 
                                        <select id="days_list">
                                        </select>
                                    </p>
                                     </div>
                                    <button id="bottoneSovrapposizione" class="bottone" onclick="sovraCheck()">Sovrapposizione</button>
                                    <button id="buffer3km" class="bottone" onclick="bufferCheck3km()">Buffer 3km</button>
                                    <button id="buffer500mt" class="bottone" onclick="bufferCheck500mt()">Buffer 500mt</button>
                                </div>
                            </div>
                        </div>
                    </div>
                -->
                </div>
            </div>
            <footer class="bg-white sticky-footer">
                <div class="container my-auto">
                    <div class="text-center my-auto copyright"><span>Copyright © Uniparthenope 2023</span></div>
                </div>
            </footer>
        </div><a class="border rounded d-inline scroll-to-top" href="#page-top"><i class="fas fa-angle-up"></i></a>
    </div>
    <script src="{{ url_for('static', filename='bootstrap/js/bootstrap.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/source/TileWMS.js"></script>
    <script>

        var slider = document.getElementById("myRange");
        var output = document.getElementById("demo");
        var map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.XYZ({
                        // url: 'https://tile.thunderforest.com/neighbourhood/{z}/{x}/{y}.png?apikey=41243fd1949946cf82ab777c68b39278' --- thunderforest site
                        // https://cloud.maptiler.com/maps/
                        url: 'https://api.maptiler.com/tiles/satellite/{z}/{x}/{y}.jpg?key=yNolbzVOYm8BH5d911a9' 
                    }),
                }),
            ],
            view: new ol.View({
                center: [0, 0],
                // center: [lat_client, lon_client],
                zoom: 0,
            })
        });
        var sizeFlagsKML;
        var data;
        var attivo=true;
        var attivoBuffer3km = true;
        var flag_buffer3km = false;
        var attivoBuffer500mt = true;
        var flag_buffer500mt = false;
        var flag_sovrapposizione = false;
        var i=0;
        var lon_client;
        var lat_client;
        
        function changeInput() {
            console.log("cambio input slider");

            // prendo la data dal <select>
            let selected_choice = document.getElementById('days_list');
            let value_selected_choice = selected_choice.options[selected_choice.selectedIndex].value;
            let value_without_char = value_selected_choice.replace(/-/g, "");
            // console.log("[*] data : ", value_without_char);

            // prendo l'ora dall'input slider 
            let selected_hour = slider.value / 5;
            let selected_hour_str = selected_hour.toString();
            if( selected_hour < 10 ) {
                selected_hour_str = selected_hour_str.padStart(2, '0')
            }
            // console.log("[*] ora : ", selected_hour_str);

            // pulisce la mappa dai precedenti .kml
            if(flag_sovrapposizione==false){
                var layers = map.getLayers().getArray();
                layers.forEach(function(layer) {
                if (layer instanceof ol.layer.Vector) {
                        layer.getSource().clear();
                    }
                });
            }

            // crea lo stile ( cambio colore ) per le linee del .kml
            function changeKMLColor(feature, color) {
                feature.setStyle(new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: color,
                        width: 1
                    })
                }));
            }

            // creo dinamicamente il path del file kml in base ai parametri impostati dall'utente
            // let url_var =  '/static/KML/' + "{{session['user_dir_name']}}" + '-out/out_job/' + value_without_char + 'Z' + selected_hour_str + '.kml';
            let url_var = '/static/KML/out_job/' + value_without_char + 'Z' + selected_hour_str + '.kml';

            // carica il file kml in un vector-layer
            let targetVectorLayer = new ol.layer.Vector({
                source: new ol.source.Vector({
                    url: url_var,
                    format: new ol.format.KML(),
                })
            });

            // cambia effettivamente colore alle vector features nel kml
            targetVectorLayer.getSource().once('change', function(event) {
                if (targetVectorLayer.getSource().getState() === 'ready') {
                        var features = targetVectorLayer.getSource().getFeatures();
                        color = tinycolor.random().toHexString();
                        features.forEach(function(feature) {
                            changeKMLColor(feature, color);
                        });
                    }
                });

            
            // Controllo del buffer da 500m
            if( flag_buffer500mt == true) {
                let center = [parseFloat("{{session['lon']}}"), parseFloat("{{session['lat']}}")];
                let radius = 500;
                let circle = new ol.geom.Circle(ol.proj.fromLonLat(center), radius);
                let circleFeature = new ol.Feature(circle);
                let circleStyle = new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: 'red',
                        width: 1
                    }),
                });

                circleFeature.setStyle(circleStyle);

                // Crea un'istanza di ol.source.Vector per contenere la circonferenza
                let vectorSource = new ol.source.Vector({
                    features: [circleFeature]
                    });

                // Crea un'istanza di ol.layer.Vector per visualizzare la circonferenza sulla mappa
                let vectorLayer = new ol.layer.Vector({
                    source: vectorSource
                    });

                map.addLayer(vectorLayer);
                console.log("flag_buffer section completed")
            }
            
            // Controllo del buffer da 3km
            if( flag_buffer3km == true ) {
                let center = [parseFloat("{{session['lon']}}"), parseFloat("{{session['lat']}}")];
                let radius = 3000;
                let circle = new ol.geom.Circle(ol.proj.fromLonLat(center), radius);
                let circleFeature = new ol.Feature(circle);
                let circleStyle = new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: 'black',
                        width: 1
                    }),
                });

                circleFeature.setStyle(circleStyle);

                // Crea un'istanza di ol.source.Vector per contenere la circonferenza
                let vectorSource = new ol.source.Vector({
                    features: [circleFeature]
                    });

                // Crea un'istanza di ol.layer.Vector per visualizzare la circonferenza sulla mappa
                let vectorLayer = new ol.layer.Vector({
                    source: vectorSource
                    });

                map.addLayer(vectorLayer);
                console.log("BUFFER [3km] : Added to map")
            }

            map.addLayer(targetVectorLayer); 
        }


        function controlKmlOnLoad(){
            if("{{session['user_dir_name']}}"==""){
                console.log("[CHECK] session[kmlpath_dash] : empty");

                if("{{session['durata']}}"==""){
                    console.log("[CHECK] session[durata] : empty");
                }

            } else {
                var oraInizio = "{{ session['ora_inizio']}}";
                sizeFlagsKML = parseInt("{{ session['durata'] }}")
                data = "{{ session['data'] }}";
            
                var targetVectorLayer = new ol.layer.Vector({
                    source: new ol.source.Vector({
                        // url: '/static/KML/out_job/' + data + "Z" + (parseInt("{{ session['ora_inizio'] }}")).toString().padStart(2, '0') + ".kml",
                        url: '/static/KML/' + "{{session['user_dir_name']}}" + '-out/out_job/' + data + 'Z' + (parseInt("{{ session['ora_inizio'] }}")).toString().padStart(2, '0') + '.kml',
                        format: new ol.format.KML()
                    })
                });

                map.getView().setCenter(ol.proj.fromLonLat([parseFloat("{{session['lon']}}"), parseFloat("{{session['lat']}}")]));
                map.getView().setZoom(13);
                map.addLayer(targetVectorLayer);

                document.getElementById('options_simulation').style.visibility = 'visible';
                document.getElementById('options_map').style.visibility = 'visible';
                /* 
                document.getElementById('div_slider').style.visibility = 'visible';
                document.getElementById('bottoneSovrapposizione').style.visibility = 'visible';
                document.getElementById('buffer3km').style.visibility = 'visible';
                document.getElementById('buffer500mt').style.visibility = 'visible';
                document.getElementById('div_slider').style.visibility = 'visible';
                */ 

                let data_standard = moment(data);
                let data_formatted = data_standard.format('YYYY-MM-DD');
                let int_durata = parseInt("{{session['durata']}}");

                let object_option = document.createElement('option');
                object_option.value = data_formatted;
                object_option.text = data_formatted;
                document.getElementById("days_list").appendChild(object_option);

                if( int_durata > 24) {
                    let tot_giorni = int_durata / 24;
                    for(let k=1; k<=tot_giorni; k++) {
                        var_object = document.createElement('option');
                        let next_day = (data_standard.add(1, 'day')).format('YYYY-MM-DD');
                        var_object.value = next_day;
                        var_object.text = next_day;
                        document.getElementById('days_list').appendChild(var_object);             
                    }
                }
            }
        }
/* 
        function nextKML(){

            if( i > parseInt("{{session['durata']}}")) {
                console.log("Max ora durata simulazione");
                return;
            }

            if( ((i+1)%24) == 0 && i!=0) {
                let data_var = moment(data);
                let new_data = data_var.add(1, 'day');
                let format_data = new_data.format('YYYY-MM-DD');
                data = format_data.replace(/-/g, "");
                // normalizzazione dell'indice ( che rappresenta l'ora )
                i = i - 23;
                document.getElementById("data_data").innerText = format_data.toString();
            }

            i+=1;

            if(flag_sovrapposizione==false){
            
                // pulisce il layers kml precedente
                var layers = map.getLayers().getArray();
                layers.forEach(function(layer) {
                if (layer instanceof ol.layer.Vector) {
                        layer.getSource().clear();
                    }
                });
            }

            // crea lo stile ( cambio colore ) per le linee del .kml
            function changeKMLColor(feature, color) {
                feature.setStyle(new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: color,
                        width: 1
                    })
                }));
            }
            
            // carica il file kml in un vector-layer
            var targetVectorLayer = new ol.layer.Vector({
                source: new ol.source.Vector({
                    url : '/static/KML/out_job/' + data + "Z" + (parseInt("{{ session['ora_inizio'] }}") + i ).toString().padStart(2, '0') + ".kml",
                    // url : '/static/KML/' + "{{session['user_dir_name']}}" + '-out/out_job/' + data + "Z" + (parseInt("{{ session['ora_inizio'] }}") + i ).toString().padStart(2, '0') + ".kml",
                    format: new ol.format.KML(),
                })
            });

            // cambia effettivamente colore alle vector features nel kml
            targetVectorLayer.getSource().once('change', function(event) {
                if (targetVectorLayer.getSource().getState() === 'ready') {
                        var features = targetVectorLayer.getSource().getFeatures();
                        color = tinycolor.random().toHexString();
                        features.forEach(function(feature) {
                            changeKMLColor(feature, color);
                        });
                    }
                });

            
            // Controllo del buffer da 500m
            if( flag_buffer500mt == true) {
                let center = [parseFloat("{{session['lon']}}"), parseFloat("{{session['lat']}}")];
                let radius = 500;
                let circle = new ol.geom.Circle(ol.proj.fromLonLat(center), radius);
                let circleFeature = new ol.Feature(circle);
                let circleStyle = new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: 'red',
                        width: 1
                    }),
                });

                circleFeature.setStyle(circleStyle);

                // Crea un'istanza di ol.source.Vector per contenere la circonferenza
                let vectorSource = new ol.source.Vector({
                    features: [circleFeature]
                    });

                // Crea un'istanza di ol.layer.Vector per visualizzare la circonferenza sulla mappa
                var vectorLayer = new ol.layer.Vector({
                    source: vectorSource
                    });

                map.addLayer(vectorLayer);
                console.log("flag_buffer section completed")
            }
            
            // Controllo del buffer da 3km
            if( flag_buffer3km == true ) {
                let center = [parseFloat("{{session['lon']}}"), parseFloat("{{session['lat']}}")];
                let radius = 3000;
                let circle = new ol.geom.Circle(ol.proj.fromLonLat(center), radius);
                let circleFeature = new ol.Feature(circle);
                let circleStyle = new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: 'red',
                        width: 1
                    }),
                });

                circleFeature.setStyle(circleStyle);

                // Crea un'istanza di ol.source.Vector per contenere la circonferenza
                let vectorSource = new ol.source.Vector({
                    features: [circleFeature]
                    });

                // Crea un'istanza di ol.layer.Vector per visualizzare la circonferenza sulla mappa
                var vectorLayer = new ol.layer.Vector({
                    source: vectorSource
                    });

                map.addLayer(vectorLayer);
                console.log("BUFFER [3km] : Added to map")
            }

            map.addLayer(targetVectorLayer);  
            document.getElementById("data_ora").innerText = i.toString();
            console.log("Ora successiva - load kml path : ", '/static/KML/' + "{{session['user_dir_name']}}" + '-out/out_job/' + data + "Z" + (parseInt("{{ session['ora_inizio'] }}") + i ).toString().padStart(2, '0') + ".kml");
        }

        function previousKML(){

            if( ((i-1)%24) == 0 && i!=0) { 
                let data_var = moment(data);
                let new_data = data_var.subtract(1, 'day');
                let format_data = new_data.format('YYYY-MM-DD');
                data = format_data.replace(/-/g, "");
                i = i + 23;

                document.getElementById("data_data").innerText = format_data.toString();
            }

            i-=1;


            if(flag_sovrapposizione==false) {
                var layers = map.getLayers().getArray();
                layers.forEach(function(layer) {
                    if (layer instanceof ol.layer.Vector) {
                        layer.getSource().clear();
                    }
                });
            }

            function changeKMLColor(feature, color) {
                feature.setStyle(new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: color,
                        width: 1
                    })
                }));
            }
       
            var targetVectorLayer = new ol.layer.Vector({
                source: new ol.source.Vector({
                    url: '/static/KML/out_job/' + data + "Z" + (parseInt("{{ session['ora_inizio'] }}") + (i-1) ).toString().padStart(2, '0') + ".kml",
                    // url: '/static/KML/' + "{{session['user_dir_name']}}" + '-out/out_job/' + data + "Z" + (parseInt("{{ session['ora_inizio'] }}") + i ).toString().padStart(2, '0') + ".kml",
                    format: new ol.format.KML(),
                })
            });

            targetVectorLayer.getSource().once('change', function(event) {
                if (targetVectorLayer.getSource().getState() === 'ready') {
                        var features = targetVectorLayer.getSource().getFeatures();
                        color = tinycolor.random().toHexString();
                        features.forEach(function(feature) {
                            changeKMLColor(feature, color);
                        });
                    }
                });
            
            
            // Controllo del buffer da 500m
            if( flag_buffer500mt == true) {
                let center = [parseFloat("{{session['lon']}}"), parseFloat("{{session['lat']}}")];
                let radius = 500;
                let circle = new ol.geom.Circle(ol.proj.fromLonLat(center), radius);
                let circleFeature = new ol.Feature(circle);
                let circleStyle = new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: 'red',
                        width: 1
                    }),
                });

                circleFeature.setStyle(circleStyle);

                // Crea un'istanza di ol.source.Vector per contenere la circonferenza
                let vectorSource = new ol.source.Vector({
                    features: [circleFeature]
                    });

                // Crea un'istanza di ol.layer.Vector per visualizzare la circonferenza sulla mappa
                var vectorLayer = new ol.layer.Vector({
                    source: vectorSource
                    });

                map.addLayer(vectorLayer);
                console.log("flag_buffer section completed")
            }
            
            // Controllo del buffer da 3km
            if( flag_buffer3km == true ) {
                let center = [parseFloat("{{session['lon']}}"), parseFloat("{{session['lat']}}")];
                let radius = 3000;
                let circle = new ol.geom.Circle(ol.proj.fromLonLat(center), radius);
                let circleFeature = new ol.Feature(circle);
                let circleStyle = new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: 'red',
                        width: 1
                    }),
                });

                circleFeature.setStyle(circleStyle);

                // Crea un'istanza di ol.source.Vector per contenere la circonferenza
                let vectorSource = new ol.source.Vector({
                    features: [circleFeature]
                    });

                // Crea un'istanza di ol.layer.Vector per visualizzare la circonferenza sulla mappa
                var vectorLayer = new ol.layer.Vector({
                    source: vectorSource
                    });

                map.addLayer(vectorLayer);
                console.log("BUFFER [3km] : Added to map")
            }
          
            // Aggiunta kml della simulazione alla mappa
            map.addLayer(targetVectorLayer);
            document.getElementById("data_ora").innerText = i.toString();
            console.log("Ora successiva - load kml path : ", '/static/KML/' + "{{session['user_dir_name']}}" + '-out/out_job/' + data + "Z" + (parseInt("{{ session['ora_inizio'] }}") + i ).toString().padStart(2, '0') + ".kml");

        }
*/

        function sovraCheck() {
            attivo = !attivo;
            var bottone = document.getElementById("bottoneSovrapposizione");
            if (attivo) {
                bottone.classList.remove("disattivato");
                console.log("SOVRAPPOSIZIONE : disattivato");
                flag_sovrapposizione = false;
            } else {
                bottone.classList.add("disattivato");
                console.log("SOVRAPPOSIZIONE : attivato");
                flag_sovrapposizione = true;
            }
        }

        function bufferCheck3km() {
            attivoBuffer3km = !attivoBuffer3km;
            var bottone = document.getElementById("buffer3km");
            if (attivoBuffer3km) {
                bottone.classList.remove("disattivato");
                console.log("BUFFER [3km] : disattivato");
                flag_buffer3km = false;
            } else {
                bottone.classList.add("disattivato");
                console.log("BUFFER [3km] : attivato");
                flag_buffer3km = true;
            }
            
        }

        function bufferCheck500mt() {
            attivoBuffer500mt = !attivoBuffer500mt;
            var bottone = document.getElementById("buffer500mt");
            if (attivoBuffer500mt) {
                bottone.classList.remove("disattivato");
                console.log("BUFFER [500mt] : disattivato");
                flag_buffer500mt = false;
            } else {
                bottone.classList.add("disattivato");
                console.log("BUFFER [500mt]: attivato");
                flag_buffer500mt = true;
            }
            
        }

        output.innerHTML = slider.value;
        slider.oninput = function() {
                output.innerHTML = this.value / 5;
        }
        document.getElementById('myRange').addEventListener("input", changeInput);
    
    </script>       
    <!-- 
    <script src="{{ url_for('static', filename='js/KML.js') }}"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>    
        var intervalId;

        function startUpdate() {
            console.log("update started")
            intervalId = setInterval(updateProgress, 1000);
        } 

        function stopUpdate() {
            clearInterval(intervalId);
        }
    
        function updateProgress() {
            // Send an AJAX request to the '/progress' route
            fetch('/progress')
                .then(response => response.json())
                .then(data => {
                    console.log("updating")

                    // Update the progress bar with the new progress
                    const progressBar = document.querySelector('.progress-bar');
                    progressBar.style.width = Math.round(data.progress) + '%';
                    progressBar.textContent = Math.round(data.progress) + '%';

                    console.log(console.log(data.progress))
                    // Stop checking for progress when maximum files is reached
                    if (data.progress === 100) {

                        if (data.state === 1) {
                            var myTable = document.getElementById('state-table');
                            myTable.rows[1].cells[1].innerHTML = 'COMPLETATO';
                        }

                        if (data.state === 2 || data.state === -1) {
                            var myTable = document.getElementById('state-table');
                            document.getElementById("icancelbtn").disabled = true; 
                            myTable.rows[1].cells[1].innerHTML = 'ERRORE';
                        }


                        if (data.state === 3) {
                            var myTable = document.getElementById('state-table');
                            myTable.rows[1].cells[1].innerHTML = 'CANCELLATO';
                        }

                        console.log(console.log(data.progress === 100))
                        console.log("finally updating")
                        var s = document.getElementById("update");
                        s.value = "False";
                        document.getElementById("progressbar").className = "progress-bar";
                        loadKmlToMap(data.kmlpath);
                        clearInterval(intervalId);      
                    }
                });
        }
    </script>
    -->

</body>
</html>